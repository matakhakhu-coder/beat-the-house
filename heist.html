<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHIMERA PROTOCOL // TERMINAL V2.1</title>
    <style>
        :root { 
            --bg: #050505; 
            --green: #00ff41; 
            --dim-green: #004411; 
            --alert: #ff0055; 
            --text: #a8f0a8; 
            --scanline: rgba(0, 255, 65, 0.03);
        }
        
        * { box-sizing: border-box; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: 'Courier New', monospace; 
            margin: 0; padding: 0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* CRT EFFECTS */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* BOOT SEQUENCE */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
            font-size: 1.5em; color: var(--green);
        }
        .boot-line { opacity: 0; animation: fadeIn 0.1s forwards; margin-bottom: 10px; text-shadow: 0 0 10px var(--green); }

        /* MARQUEE TICKER */
        #marquee-container {
            background: var(--alert);
            color: #000;
            height: 28px;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            font-weight: bold;
            font-size: 0.9em;
            display: flex; align-items: center;
            border-bottom: 2px solid var(--dim-green);
            z-index: 50;
        }
        #marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 20s linear infinite;
        }
        .msg-tag { background: #000; color: var(--alert); padding: 0 5px; margin-right: 5px; font-weight: 900; }

        /* MAIN LAYOUT */
        #app-container { opacity: 0; transition: opacity 1s; display: flex; flex-direction: column; height: 100%; padding: 15px; z-index: 10; }
        
        .header { 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--green); padding-bottom: 10px; margin-bottom: 15px; 
        }
        
        /* LIVE CLOCK */
        .clock-group { text-align: right; }
        .unix-digit { 
            font-size: 1.5em; font-weight: bold; color: #333; 
            display: inline-block; width: 30px; text-align: center;
            background: #111; border: 1px solid #333; margin-left: 10px;
        }
        .unix-digit.active { color: #fff; background: var(--green); box-shadow: 0 0 15px var(--green); }

        /* GRID */
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; flex-grow: 1; overflow: hidden; }
        
        .panel { 
            border: 1px solid var(--dim-green); 
            background: rgba(0, 20, 0, 0.4); 
            display: flex; flex-direction: column; 
            position: relative;
        }
        .panel-header { 
            background: var(--dim-green); color: #000; 
            padding: 2px 8px; font-weight: bold; font-size: 0.8em; letter-spacing: 2px;
        }

        /* LEDGER */
        #ledger { overflow-y: auto; flex-grow: 1; padding: 10px; font-size: 13px; }
        .entry { display: flex; justify-content: space-between; border-bottom: 1px dashed #222; padding: 4px 0; }
        .entry.win { color: var(--green); text-shadow: 0 0 3px var(--green); background: rgba(0, 255, 65, 0.05); }
        .entry.loss { color: #522; }
        .entry.grand { color: var(--alert); font-weight: bold; animation: pulse 1s infinite; }
        .ts-hl { font-weight: bold; color: #fff; }

        /* CONTROLS */
        .controls { padding: 15px; display: flex; flex-direction: column; gap: 15px; height: 100%; overflow-y: auto; }
        
        .metric-box { display: flex; justify-content: space-between; font-size: 1.2em; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        input { 
            background: #000; border: 1px solid var(--dim-green); color: var(--green); 
            padding: 10px; width: 100%; font-family: inherit; outline: none; margin-bottom: 5px;
        }
        input:focus { border-color: var(--green); box-shadow: 0 0 10px var(--dim-green); }

        button { 
            background: var(--dim-green); color: #000; border: none; 
            padding: 12px; width: 100%; cursor: pointer; font-family: inherit; 
            font-weight: bold; text-transform: uppercase; transition: all 0.2s; 
        }
        button:hover { background: var(--green); box-shadow: 0 0 15px var(--green); }
        button.danger { background: #500; color: #faa; }
        button.danger:hover { background: var(--alert); color: #fff; box-shadow: 0 0 15px var(--alert); }

        /* CHAT MODULE */
        #chat-module {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #333;
            background: #000;
            padding: 5px;
            margin-top: 10px;
            min-height: 150px;
        }
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            font-size: 0.8em;
            margin-bottom: 5px;
            color: #888;
        }
        .chat-msg { margin-bottom: 2px; word-break: break-word; }
        .chat-user { font-weight: bold; }
        
        /* SEASON END STATE (LEGACY MODE) */
        #memorial-panel { 
            display: none; text-align: center; color: var(--text); padding: 20px; 
            border: 2px solid var(--alert); background: rgba(50, 0, 0, 0.2); height: 100%;
            flex-direction: column; justify-content: center; gap: 20px;
        }
        .winner-name { font-size: 2em; color: var(--alert); text-shadow: 0 0 10px var(--alert); }
        .code-reveal { font-family: monospace; background: #000; padding: 10px; border: 1px dashed var(--alert); color: #fff; }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .glitch { animation: shake 0.5s; filter: hue-rotate(90deg); }
        .red-flash { animation: shake 0.2s; border: 1px solid var(--alert); box-shadow: inset 0 0 50px rgba(255,0,0,0.2); }

    </style>
</head>
<body>

    <div id="boot-screen"></div>

    <div id="marquee-container">
        <div id="marquee-content">// SYSTEM_READY // LISTENING_FOR_SIGNAL //</div>
    </div>

    <div id="app-container">
        
        <div class="header">
            <div>
                <div style="font-size: 1.2em; font-weight: bold;">CHIMERA PROTOCOL</div>
                <div style="font-size: 0.8em; opacity: 0.7;">v2.1.0 // STABLE</div>
            </div>
            <div class="clock-group">
                <span id="wall-clock">00:00:00.00</span>
                <span id="unix-digit" class="unix-digit">-</span>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <div class="panel-header">LIVE_TRANSACTION_LEDGER</div>
                <div id="ledger">Connecting...</div>
            </div>

            <div class="panel">
                <div class="panel-header">COMMAND_DECK</div>
                
                <div id="active-controls" class="controls">
                    <div class="metric-box">
                        <span id="display-user">GUEST</span>
                        <span id="display-vault" style="color: var(--green);">R----</span>
                    </div>

                    <div>
                        <input type="text" id="username-input" placeholder="SET_IDENTITY">
                        <button onclick="setIdentity()" style="padding: 5px; font-size: 0.8em;">LOGIN</button>
                    </div>

                    <div style="border: 1px dashed var(--dim-green); padding: 10px; margin-top: 10px;">
                        <div style="font-size: 0.7em; margin-bottom: 5px; opacity: 0.7;">INJECTION_VECTOR (COST: R10)</div>
                        <button onclick="playGame()" id="btn-play">EXECUTE TRANSACTION</button>
                        <div id="result-msg" style="margin-top: 5px; height: 1.2em; text-align: center; font-size: 0.8em;">READY</div>
                    </div>

                    <div id="chat-module">
                        <div style="border-bottom: 1px solid #333; margin-bottom: 5px; font-size: 0.7em; color: #666;">// ENCRYPTED_CHANNEL</div>
                        <div id="chat-history">
                            <div class="chat-msg">Loading...</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="chat-input" placeholder="MSG..." style="margin: 0; padding: 5px;">
                            <button onclick="sendChat()" style="width: auto; padding: 5px 10px;">></button>
                        </div>
                    </div>

                    <div style="margin-top: auto; border-top: 2px solid var(--alert); padding-top: 10px;">
                        <div style="color: var(--alert); font-size: 0.7em; margin-bottom: 5px;">ROOT_ACCESS_OVERRIDE</div>
                        <input type="text" id="solve-input" placeholder="ENTER_ALGORITHM_KEY" style="border-color: #522;">
                        <button class="danger" onclick="submitSolve()">ATTEMPT OVERRIDE</button>
                    </div>
                </div>

                <div id="memorial-panel">
                    <div style="font-size: 0.8em; letter-spacing: 3px;">SEASON 1 COMPLETE</div>
                    <div class="winner-name" id="mem-winner">UNKNOWN</div>
                    <div>TOTAL EXTRACTION: <span id="mem-payout" style="color: var(--green); font-weight: bold;">R0</span></div>
                    <div style="margin-top: 20px;">THE SOURCE CODE:</div>
                    <div class="code-reveal">timestamp % 10 == 7<br>AND<br>volume >= 3</div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = ""; 
        
        // Identity Recovery
        let currentUser = localStorage.getItem('chimera_user');
        if (!currentUser) {
            currentUser = "GUEST_" + Math.floor(Math.random() * 9999);
            localStorage.setItem('chimera_user', currentUser);
        }
        
        let isSeasonActive = true;

        // --- 1. BOOT SEQUENCE ---
        const bootLines = ["CONNECTING TO CHIMERA PROTOCOL...", "ENCRYPTING...", "STATUS: READY"];
        async function runBoot() {
            const screen = document.getElementById('boot-screen');
            for (let line of bootLines) {
                const div = document.createElement('div');
                div.className = 'boot-line';
                div.innerText = line;
                screen.appendChild(div);
                await new Promise(r => setTimeout(r, 400));
            }
            await new Promise(r => setTimeout(r, 500));
            screen.style.opacity = 0;
            document.getElementById('app-container').style.opacity = 1;
            setTimeout(() => screen.remove(), 1000);
        }
        runBoot();

        // --- 2. LIVE CLOCK (UNIX SYNC) ---
        function updateClock() {
            const now = new Date();
            // Wall Clock
            document.getElementById("wall-clock").innerText = now.toLocaleTimeString('en-GB') + "." + String(now.getMilliseconds()).padStart(3,'0').substring(0,2);
            
            // Unix Digit (The Hint)
            const unixSec = Math.floor(now.getTime() / 1000);
            const digit = String(unixSec).slice(-1);
            const digitEl = document.getElementById("unix-digit");
            
            digitEl.innerText = digit;
            if (digit === "7") {
                digitEl.classList.add("active");
            } else {
                digitEl.classList.remove("active");
            }
            requestAnimationFrame(updateClock);
        }
        updateClock();

        // --- 3. CORE ACTIONS ---
        function setIdentity() {
            const val = document.getElementById("username-input").value;
            if(val) { 
                currentUser = val.replace(/[^a-zA-Z0-9_]/g, '').substring(0, 15);
                localStorage.setItem('chimera_user', currentUser);
                document.getElementById("display-user").innerText = currentUser;
                document.getElementById("username-input").value = "";
            }
        }

        async function playGame() {
            if(!isSeasonActive) return;
            const resBox = document.getElementById("result-msg");
            resBox.innerText = "PROCESSING...";

            try {
                const res = await fetch(API_URL + "/play", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: currentUser })
                });
                const data = await res.json();

                if (data.outcome === "WIN") {
                    resBox.innerText = `SUCCESS: +R${data.payout}`;
                    resBox.style.color = "var(--green)";
                    document.body.classList.add("glitch");
                    setTimeout(() => document.body.classList.remove("glitch"), 500);
                } else {
                    resBox.innerText = data.message.substring(0, 25);
                    resBox.style.color = "var(--alert)";
                    document.body.classList.add("red-flash");
                    setTimeout(() => document.body.classList.remove("red-flash"), 200);
                }
                refreshData();
            } catch(e) { resBox.innerText = "NETWORK ERROR"; }
        }

        // --- 4. CHAT SYSTEM ---
        async function loadChat() {
            try {
                const res = await fetch(API_URL + "/discuss");
                const msgs = await res.json();
                const chatBox = document.getElementById('chat-history');
                
                // Only scroll if already at bottom
                const shouldScroll = chatBox.scrollHeight - chatBox.scrollTop === chatBox.clientHeight;

                chatBox.innerHTML = msgs.map(m => {
                    const time = new Date(m.time * 1000).toLocaleTimeString([], {hour12: false, hour:'2-digit', minute:'2-digit'});
                    const color = m.user === currentUser ? "var(--green)" : "#666";
                    return `<div class="chat-msg">
                        <span style="color:#444">[${time}]</span>
                        <span class="chat-user" style="color:${color}">${m.user}:</span>
                        <span style="color:#ccc">${m.text}</span>
                    </div>`;
                }).join("");

                if(shouldScroll) chatBox.scrollTop = chatBox.scrollHeight;
            } catch(e) {}
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt) return;
            input.value = "...";
            
            await fetch(API_URL + "/discuss", {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({user_id: currentUser, message: txt})
            });
            input.value = "";
            loadChat();
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if(e.key==='Enter') sendChat();
        });

        async function submitSolve() {
            const formula = document.getElementById("solve-input").value;
            if(!formula) return;
            try {
                const res = await fetch(API_URL + "/submit", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: currentUser, formula: formula })
                });
                const data = await res.json();
                if(data.outcome === "GRAND_SOLVE") {
                    alert("SYSTEM CRACKED.");
                    location.reload();
                } else {
                    alert(data.message);
                }
            } catch(e) {}
        }

        // --- 5. DATA POLLING ---
        async function refreshData() {
            // Season Status
            const statusRes = await fetch(API_URL + "/season/status");
            const status = await statusRes.json();
            
            isSeasonActive = !status.status.startsWith("LOCKED");
            
            if (isSeasonActive) {
                document.getElementById("display-vault").innerText = "R" + status.vault_balance;
            } else {
                document.getElementById("active-controls").style.display = "none";
                document.getElementById("memorial-panel").style.display = "flex";
                document.getElementById("mem-payout").innerText = "R" + status.vault_balance;
            }

            // Ledger
            const histRes = await fetch(API_URL + "/history");
            const histData = await histRes.json();
            
            const ledger = document.getElementById("ledger");
            ledger.innerHTML = histData.map(tx => {
                // Adapter for server data format
                const date = new Date(tx.time * 1000);
                const timeStr = date.toLocaleTimeString('en-GB');
                const sec = timeStr.split(':')[2];
                const isWin = tx.amt > 0;
                
                let cls = isWin ? "entry win" : "entry loss";
                let text = isWin ? `EXTRACTED R${tx.amt}` : `FEE PAID`;
                
                // Highlight '7' in timestamp
                const displayTime = timeStr.replace(sec, `<span class="ts-hl">${sec}</span>`);

                return `<div class="${cls}">
                    <span style="opacity:0.6; font-size:0.9em; width:80px;">${displayTime}</span>
                    <span style="width:100px; font-weight:bold;">${tx.user}</span>
                    <span style="text-align:right; flex-grow:1;">${text}</span>
                </div>`;
            }).join("");
        }

        async function updateTicker() {
            const res = await fetch(API_URL + "/broadcast/feed");
            const data = await res.json();
            // Server returns single message object
            const html = `<span class="msg-tag">[!]</span> ${data.message}`;
            const tape = document.getElementById("marquee-content");
            if(tape.innerHTML !== html) tape.innerHTML = html;
        }

        // Init loops
        setInterval(refreshData, 2000);
        setInterval(loadChat, 2000);
        setInterval(updateTicker, 5000);
        
        refreshData();
        loadChat();
        updateTicker();
        document.getElementById("display-user").innerText = currentUser;

    </script>
</body>
</html>